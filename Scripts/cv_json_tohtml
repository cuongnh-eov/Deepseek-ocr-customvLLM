from bs4 import BeautifulSoup as bs  
from html import escape  
import jsonlines  
  
def format_html(img):  
    '''Reconstruct HTML from tokenized annotation'''  
    html_code = img['html']['structure']['tokens'].copy()  
    to_insert = [i for i, tag in enumerate(html_code) if tag in ('<td>', '>')]  
    for i, cell in zip(to_insert[::-1], img['html']['cells'][::-1]):  
        if cell['tokens']:  
            from html import escape  
            cell = [escape(token) if len(token) == 1 else token for token in cell['tokens']]  
            cell = ''.join(cell)  
            html_code.insert(i + 1, cell)  
    html_code = ''.join(html_code)  
      
    # Sửa lỗi: dùng f-string thay vì % formatting  
    html_code = f'''<html>  
                   <head>  
                   <meta charset="UTF-8">  
                   <style>  
                   table, th, td {{  
                     border: 1px solid black;  
                     font-size: 10px;  
                   }}  
                   </style>  
                   </head>  
                   <body>  
                   <table frame="hsides" rules="groups" width="100%">  
                     {html_code}  
                   </table>  
                   </body>  
                   </html>'''  
      
    # Prettify HTML  
    from bs4 import BeautifulSoup as bs  
    soup = bs(html_code)  
    html_code = soup.prettify()  
    return html_code

with jsonlines.open('/home/cuongnh/PycharmProjects/TTTS_01/TTS-01/data/pubtabnet_100_samples/labels_100.jsonl', 'r') as reader:  
    for i, annotation in enumerate(reader):  
        # Reconstruct HTML từ tokens  
        html_string = format_html(annotation)  
          
        # Lưu ra file  
        with open(f"output_{annotation['filename']}.html", "w", encoding="utf-8") as f:  
            f.write(html_string)  
          
        print(f"Processed {i+1}: {annotation['filename']}")